# 我的开源GIS解决方案之路



## 缘起

今天跟大家分享一下我的开源GIS解决方案经历。从第一版到现在，前后跨度7年，经历了3个公司，共封装了5版地图API。

我一直在传统IT行业，公司都是以做面向政府的项目为主，俗称toG业务。

这种公司里，GIS在其中的应用通常为两种，一种是GIS结合公司的业务形成一个xx地理信息系统或是xx一张图系统，另一种是结合公司业务封装一套地图API，为公司的其它业务系统提供地图技术支撑，类似于高德地图API、百度地图API。

我们今天重点聊一下封装地图API这个事。

文章稍微有点长，如果你只想了解一下最新的技术架构，可以直接跳过前面去看第五版和最后的总结，但我还是建议你从第一版开始看，因为没有前面4版就不会有第5版，只看总结就和读名言警句效果一样，不能感同身受。

5版地图API中， 第一版使用的ArcGIS，后面的都是使用开源GIS。



## 第一版 2014年

### 背景

公司做环保业务，业务系统主要用C#开发，业务系统中涉及地图的部分使用ArcGIS Flex API开发，由GIS开发人员负责。那个年代，地图还主要是用Flex开发，因为Flex在那时很炫酷。

随着项目的增加，发现很多业务功能在项目里是通用的，再后来发现，如果把业务功能和地图功能分离，再把Flex编写的地图功能封装一套面向JS的接口，C#开发人员就可以自己完成地图相关的工作了。

于是我们准备封装一套用Felx编写的，面向C#开发人员的JS地图API。

### 技术架构

用ArcGIS Flex API开发地图功能，Flex支持和JS交互，利用这一特性将Flex开发的地图功能，封装成面向JS的接口。

开发一个简单的帮助网站，提供接口的调用示例和使用说明。

### 经验总结

地图API发布后，在做技术支持的过程中发现一个有趣的现象，关于地图API的使用，完全不懂GIS的初级C#开发人员觉得好用，原因是能帮他们解决问题，有困难时可以随时找我们技术支持。

了解一点GIS的中级C#开发人员觉得不好用，他们会拿我们的地图API和ArcGIS JS API对比，觉得后者更好用，但由于ArcGIS JS API的地图偏丑，我们也不提供技术支持，需要他们自己去研究，最终还是选择用我们的地图API。

了解一点GIS的高级C#开发人员基本不用，其中有两个同事的反应令我印象深刻，一个同事说：”你们自己开发的东西，自己都不用“。言外之意是，你们自己都不用的东西不会好用。但我们的想法是，把Flex封装一套JS的地图接口是因为Flex入门有门槛，我们GIS开发人员既然都会Flex了，而且我们开发的地理信息系统，整个都是用Flex开发的，那肯定是直接用ArcGIS Flex API会更灵活，所以不用。

还有一个同事更牛，他直接去研究Flex，不会的就问我们，入门后直接封装了一套地图接口自己用。我们研究过他封装的接口，虽然功能简单了些，但定义接口时的出发点明显感觉和我们不一样，我们是站在功能的角度封装，尽量保证接口的复用度高，比如添加点，添加线，缓冲等功能。他是站在用户的角度封装，比如从数据库查出来一堆数据，把这堆数据直接丢给接口，就在地图上展示出来了。总体而言，他的接口封装度更高，更贴近他的实际使用习惯，而我们的接口更像是把ArcGIS的Flex接口翻译了一套JS的。

还注意到一个现象，经常有使用我们接口的业务开发人员跑过来问，为什么我的地图不显示？经历的多了，发现通常有两种原因，一种是地图服务的地址不对，当时的地图服务都是用ArcGIS server发布的，ArcGIS server地图服务的rest地址是个网页，这个网页打开后，有很多级的链接地址，业务人员不知道应该拷贝哪一级的地址，经常拷错，所以地图出不来。另一种是，添加多个地图时，地图间的坐标不一致，导致添加的地图不显示。

想想也是，地图服务和地图坐标这些知识对于不懂GIS的开发人员来说还是挺难的。

虽然第一版有这样那样的问题，但在当时还是提升了部门的整体工作效率。



## 第二版 2016年

### 背景

换公司了，新公司做网安业务，有海量定位数据，GIS在其中的作用是，对定位数据进行提取、分析、展示，从而帮助客户解决业务问题。

公司有一个GIS应用系统，和GIS强相关的业务功会能放在这里，另外其它部门有地图的功能需求时也会找到GIS部门来，这个场景和上家公司很像。

GIS应用系统的底图数据使用互联网地图瓦片，部署在客户内网中，无法访问互联网，所以需要把地图的瓦片下载下来，再拷贝到客户内网发布。发布的方式是，使用geoserver的GeoWebCache功能读取瓦片并发布成WMS地图服务，前端使用openlayers进行地图展示。

第二版地图API使用openlayers，有了第一版地图API的经验，第二版地图API重点解决了地图的地图资源问题和地图坐标问题。

### 技术架构

1. 地图资源问题，对底图资源进行统一管理，提供多个底图类型供用户选择，包括高德地图、谷歌地图、天地图等。
2. 地图坐标问题，对外统一使用WGS84坐标，地图API内部负责将WGS84坐标转换为和底图匹配的坐标，包括gcj02坐标、bd09坐标等。
3. 简化互联网地图瓦片发布流程，在openlayers中写一个加载本地瓦片地图的功能，这样地图瓦片可以直接使用tomcat发布，不再需要使用geoserver的GeoWebCache发布。
4. GIS数据分析，GIS数据的分析、提取工作，使用ArcGIS Engine开发单独的工具完成。

### 经验总结

1. 解决地图资源和坐标问题，可以大大提升用户体验。
2. 关于地图下载器，虽然大家都有能力自己写一个出来，但真的挺不划算的，最好的解决方案就是花公司的钱去买一个许可，站在公司的角度这都没几块钱。
3. ArcGIS Engine的版本，C#版的比较稳定，Java版的超级难用，非常不稳定，动不动就死给你看，更不要尝试去把它部署到Linux服务器，不要问我是怎么知道的。我当时为了在linux上部署，先开发了一版java的，部署后一天崩溃好几次，动不动就内存溢出，根本没法用，没办法只能重新写了一版C#的部署在windows服务器上。



## 第三版 2017年 

### 背景

换公司了，新公司做管网业务，相比前面两家，业务和GIS的相关性更强一些，需要对管网GIS数据进行编辑、存储、发布和应用。公司之前地图都是使用ArcGIS开发的，正在谋求向开源GIS转型。于是就顺理成章的开始了我的第三版地图API开发。

在开始这一版之前，仔细研究了一下高德和百度地图API，并问了自己两个问题：

一、为什么非GIS开发人员，能够用高德、百度地图API解决问题，却用不了ArcGIS，openlayers，leaflet？

二、非GIS开发人员在用互联网地图API时遇到了哪些其它问题？

下面是我自己的理解，

第一个问题是因为，1、非GIS开发人员不用自己发布地图数据，互联网地图解决了地图资源问题，地图都是官方提供的，只管用就行。2、互联网地图API的帮助文档和示例都是中文的。入门难度和其它JS控件是一样，门槛低。

第二个问题，我在尝试使用这两个API以后发现，API的离线使用是个问题，互联网地图API都只能在线使用，无法离线使用，如果遇到不能访问互联网的情况，就无法使用了。

从这一版开始，我们开始尝试在用户体验上去对标高德、百度地图API。

### 技术选型

前台没有继续使用openlayers，而是转向更为轻巧的leaflet，当时的考虑是：

1. leaflet很小巧，核心代码结构简单容易理解，可塑性强，适合拿来改造为自己的API。
2. leaflet可以同时兼容web端和移动端
3. 有esri维护的leaflet插件，能很好的集成公司之前发布的ArcGIS地图服务

后台使用geoserver，geoserver有插件支持连接ArcGIS 的SDE空间数据库，可以很好的集成公司之前的ArcGIS空间数据库。

空间数据库使用postGIS。

桌面端开发继续使用ArcGIS Engine，没有去尝试QGIS，主要原因是，公司之前在ArcGIS Engine上有大量的技术积累，已经形成了成熟产品，转换成本会很高。

### 技术架构

在leaflet的基础上封装了一层自己的接口，原生leaflet接口不对外，当时的考虑是：

1. 和上一版一样，封装后容易解决互联网地图偏移的问题，对外统一使用WGS84坐标，内部根据不同的底图将数据转换为对应的坐标
2. 可以实现类似JQuery那样的扁平化接口，简单易用
3. leaflet中点的写法是[纬度,经度]，而我们通常更习惯使用[经度,纬度]的写法，通过封装可以解决这个问题。

需要复杂的GIS分析和业务定制的GIS分析时，编写geoserver的扩展插件，插件连接PostGIS空间数据库，通过直接调用或自定义PostGIS空间分析函数来实现。

基于geoserver的rest接口实现地图服务的自动发布。在ArcGIS Engine开发的桌面软件中，先将GIS数据导入到空间数据库中，再调用geoserver的rest接口发布地图，最终实现效果和用ArcMap将地图发布到ArcGIS server中的体验相同。

搭建一个门户网站，内容包括帮助文档、地图资源、更新说明等，帮助文档以接口为线索，接口内部有接口说明和调用事例。地图资源中提供可以使用的所有地图，包括互联网地图和自己发布的业务地图，每个地图都有id，根据这个id就可以在地图API中轻松加载地图，不需要关心地图服务是如何发布的。

将PostGIS、geoserver、tomcat全部修改为绿色版本，方便

### 经验总结

1. 可以使用SLDEditor软件解决geoserver配图不好用的问题。geoserver的配图不好用，尝试了在QGIS上配图，然后发布到geoserver上，发现QGIS上配图后生成的sld样式文件格式，有很多geoserver都不支持，也不知道是版本没对应上还是咋地，最后找了个开源工具SLDEditor来编辑样式文件，完美解决问题，但整体的使用体验跟ArcGIS差很多。
2. PostGIS的空间分析功能很好用、很强大。所以空间分析功能，我们就主要用PostGIS来实现了，比如之前写过的缓冲查询功能。
3. geoserver扩展更适合开发和生成地图服务相关的功能。GIS的空间分析功能一开始通过geoserver扩展插件实现，后来发现扩展插件的后台程序主要作用是数据传输，最主要环节的GIS空间分析环节是在空间数据库PostGIS中实现的，而geoserver的扩展开发环境比较复杂，不如自己写的java后台好维护。geoserver扩展的优势是可以直接调用geoserver的资源和功能，它更适合开发和生成地图服务相关的功能。



## 第四版 2019年

### 背景

开发出第三版后，在部门中使用了一年多，整体反应良好，有一部分懂GIS的同事，之前是使用ArcGIS JS API，用了leaflet封装的第三版地图API后，他们的第一反应是这个好轻便，比ArcGIS JS API 小了好多，加载很快。

上一版发布后，我们留意了用户的使用习惯，大家的使用习惯基本都是先看示例，找到示例后，会直接把代码拷走使用，当示例不完全满足要求时，再去翻看API说明，最好的情况就是示例代码注释完善，一眼就能看懂，拷过来就能用。

随着使用的增加，慢慢发现了一些问题。

懂GIS的同事反馈最强烈的是，能不能把原生接口放开。有个同事，每次来找我们时，都是先自己在网上找leaflet代码，然后让我们添加这个功能，整的我们都挺不好意思的。如果能把leaflet原生接口放开，有很多工作就不用找我们，他们自己就解决了。

然后是我自己，当我需要研究或测试一个地图功能时，我的第一反应不是去用我自己封装的地图API，而是更愿意直接用原生leaflet去写，因为是我觉得自己封装的地图API用起来不够灵活。天呐，这不就和第一版时，同事说的“你们自己封装的地图API自己都不用”是一样一样的嘛，如果说第一版时还有Flex语言的因素，那这第三版从内到外都是JS写的，没什么好解释的，就是让人家说中了。

还有一个问题是，因为人员有限，除了封装地图API，还有其它工作要做，感觉自己天天在对leaflet的基础功能进行封装，没有时间去研究高级的功能。如果能把原始接口放开，可以节省出很多时间。

### 能不能放开原生接口？

要放开原生接口面临几个问题：

1. 地图坐标偏移问题，之前通过封装，在对外接口和地图之间形成了一个坐标适配层，解决了坐标偏移问题。如果放开原生接口后，如何解决坐标问题？
2. 用户使用习惯问题，不懂GIS的用户会不会习惯了扁平化接口，放开后觉得原生接口不好理解？之前把leaflet中点的写法[纬度,经度]，会不会很多人适应不了？等等。
3. 版本兼容问题，上一个版本中为了追求接口的极简性，简化了很多数据类型的格式，如果放开原生接口后，还要兼容这样格式将会产生很大的工作量，而且后续每增加一个功能都要考虑一次。

解决方案：

1. 针对坐标偏移的问题，有两个方案，一是给用户提供一个坐标转换的接口，用户自己来转换坐标，但这样对用户不友好。二是对互联网地图瓦片进行纠偏，让地图统一坐标，不再偏移，这样对用户友好，但有技术难点。最终我们攻克了技术难点，采用了第二种解决方案，详见：。
2. 针对用户习惯的问题，为什么百度、高德的地图API并没有使用扁平化接口，大家却并没有觉得它们难用？我们思考后得出的结论是：在接口没有特别复杂的前提下，能解决问题，bug少，示例丰富，说明文档清晰，大家就会觉得好用。接口是否是扁平化不怎么重要。而且，leaflet的原生接口本身就已经非常简洁了，单从简洁性考虑的话，没必要再封装。
3. 关于版本兼容的问题，我们决定不对上一个版本兼容，让两个版本同时保留，慢慢过渡，新项目新产品推荐大家用这一版，老项目我们继续提供技术支持，但不再做功能升级。这样经过1、2年后，就能慢慢切换过来。事实证明这个决定是对的，到写这篇文章时，已经过去2年左右，部门里大部分系统都已经切换都了新版本。

### 技术架构

技术架构在上一版的基础上做如下调整：

1. 放开leaflet原生接口，不再对接口进行封装，改为以插件形式进行功能扩展。
2. 集成多种互联网地图资源，通过对瓦片纠偏的方式解决它们的坐标偏移问题，对外统一使用WGS84坐标。
3. 帮助文档改成以示例为线索，示例中的注释保证完善清晰，将示例代码中用到的方法给出类参考链接。
4. 将leaflet的类参考文档进行翻译，放到平台中。
5. 当有新的功能需求时，简单的功能不封装，直接给出示例，复杂的功能再考虑封装到插件中。
6. 和geoserver相关性不强的地图分析功能，迁移到java后台，geoserver中只保留和制图相关的功能。

### 经验总结

1. leaflet类参考的翻译工作没做好，一共没翻译几页，但奇怪的是从来没有用户反应过这个问题，因为用户基本不咋看文档，更多的是看示例，示例没有的，会直接问我们，文档其实是给我们自己看的（捂脸）
2. 有人问问题时，就尽量以示例的方式记录下来，后续大家在示例中能找到这个问题就不会再问了。
3. 要尽量通过工具，让平台的维护变得简单，太复杂自己就不爱维护，最后平台容易废掉。
4. 到这一版，个人认为，整体的用户体验，已经和百度、高德地图API持平了，具体分析如下：
	1. 在接口易用性上基本持平。
	2. 在地图样式上，不如百度、高德地图丰富，因为百度高德地图支持自定义地图，我们只支持网上公开的那几种样式资源，但这些资源在绝大多数情况下是够用的。
	3. 在技术支持上我们是完胜的，毕竟都在一个公司里。



## 第五版 2021年

### 背景

这一版还没有完成，年前刚做完技术预研工作，这里就把整体思路简单和大家分享一下。

上一版已经很好用了，现在已经很少有来自用户的负面反馈。产品还曾经在项目中作为整体架构中的技术中台，为项目中的其他公司提供地图技术支撑，同样反馈良好。

但我们自己还是有追求的，和高德、百度地图API相比，我们在下面几点上还需要改进：

1. 地图美观度问题，地图的底图目前都是使用互联网地图瓦片，叠加上业务数据后，数据会将底图中的注记遮盖，业务数据间也不容易实现自动避让，再加上没有好用的配图工具，导致地图在要展示的业务数据较多时就会很乱、很丑。
2. 展示性能问题，地图有时需要一些动画效果，比如用动画效果表达管网中，水的流动方向和快慢，在数据量较大时会出现明显的卡顿，导致无法使用。
3. 地图配图问题，geoserver不好配图，这个问题前面已经提到过，虽然使用SLDEditor可以生成配色文件，但一次只能生成一个图层，没有办法直接预览整体配色效果，配图效率太低，体验太差。

这一版的目标是解决上面3个问题。

### 技术选型

前台不再使用leaflet，改为使用mapboxgl，原因有两个：
1. 性能上提升，mapboxgl基于webgl技术开发，leaflet的上限在10万左右（详见leaflet如何加载10万数据），而mapboxgl支持的最大数据量取决于显卡性能和网络传输速度，理想情况下可以轻松达到百万级别。
2. 美观度上提升，mapboxgl对矢量瓦片的支持特别好，可以实现前台动态渲染地图，可以实现类似百度高德地图的自定义地图功能。

业务数据使用geoserver发布矢量瓦片

底图数据有两种方案，
1. 对地图样式要求不高，或对底图的数据准确性要求很高，可以继续现有的互联网栅格地图资源。
2. 对地图样式要求很高，但对底图数据的准确性要求不高，可以使用本地发布的OSM矢量瓦片地图，具体实现类似百度高德地图的自定义地图，百度、高德地图的矢量瓦片不对外，必须要用他们的api才能使用 ，mapbox的矢量瓦片有调用次数限制，而使用openmaptiles本地发布OSM地图可以很好的解决这个问题（详见。。。） 

底图数据的矢量瓦片用maptiles发布

5. 使用maputnik加载maptiles和geoserver发布的矢量瓦片地图，实现前台自定义配图。这里可以实现将业务数据底图的深度融合，比如把业务数据中的河流放到底图道路图层的下方，并实现标签的自动避让。正常情况下maputnik是不支持geoserver发布的矢量瓦片服务的，解决方法详见这里（）

## 总结

1. 解决地图资源问题
2. 解决坐标偏移问题，对外统一坐标
3. 对于不懂GIS的用户，是扁平化接口还是类方式的接口不重要，重要的是要有完善的示例和文档，
4. 对于懂GIS的用户，把原生接口放开很重要
5. 可直接使用的示例好于文档
6. 自己的api自己要乐意用
7. 用户支持要好
8. 平台要容易维护



* * *

原文地址：[http://gisarmory.xyz/blog/index.html?blog=GISerMission](http://gisarmory.xyz/blog/index.html?blog=GISerMission)

关注《[GIS兵器库](http://gisarmory.xyz/blog/index.html?blog=wechat)》， 第一时间获得更多高质量GIS文章。

![](http://blogimage.gisarmory.xyz/20200923063756.png)

本文章采用 [知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议 ](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)进行许可。欢迎转载、使用、重新发布，但务必保留文章署名《GIS兵器库》（包含链接：  [http://gisarmory.xyz/blog/](http://gisarmory.xyz/blog/)），不得用于商业目的，基于本文修改后的作品务必以相同的许可发布。





