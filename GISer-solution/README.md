# 我的开源GIS解决方案之路

[TOC]



## 缘起

今天给大家分享一下我的开源GIS解决方案经历，前后跨度7年，经历了3个公司，封装了5版地图API。

我一直在传统IT行业，公司都是以做面向政府的项目为主，俗称toG业务。

这种公司里，GIS在其中的应用通常为两种，一种是GIS结合公司的业务形成一个xx地理信息系统或是xx一张图系统，另一种是结合公司业务封装一套地图API，用来给公司的其它业务系统提供地图技术支撑，类似高德地图API、百度地图API。

我们今天重点聊一下封装地图API这个事。

我在3个公司一共封装了5版地图API， 第一版使用ArcGIS，后面的版本使用开源GIS。



## 第一版 2014年 A公司

### 背景

公司做环保业务，业务系统主要用C#开发，业务系统中涉及地图的部分使用ArcGIS Flex API开发，由GIS人员负责，那个年代，地图还主要是用Flex开发，因为在那时很炫酷。

随着项目的增加，发现很多业务功能在项目里是通用的，再后来发现，如果把业务功能和地图功能分离，再把flex编写的地图功能封装一套面向JS的接口，C#开发人员就可以自己完成地图相关的工作了。

### 技术架构

整体使用ArcGIS技术体系完成数据的处理、发布，这部分由GIS开发人员负责。

用ArcGIS Flex API开发地图功能，Flex支持和JS交互，利用这一特性将Flex开发的地图功能，封装成面向JS的接口。

开发了一个简单的帮助网站，提供接口的调用示例和使用说明。

### 经验总结

地图API发布后，在做技术支持的过程中发现一个有趣的现象，关于地图API的使用，初级开发人员觉得好用，原因是，能帮他们解决问题，有困难时可以随时找我们技术支持。

中级开发人员觉得不好用，他们会拿我们的地图API和ArcGIS JS API对比，觉得后者好用，但由于ArcGIS JS API的地图偏丑，我们也不提供支持，需要他们自己去研究，所以最终还是选择用我们的API。

高级人员基本不用，其中有两个人的反应令我印象深刻，一个同事说：你们自己开发的东西，自己都不用。言外之意是，你们自己都不用的东西不会好用。我们的想法是，给Flex封装一套JS的地图接口是因为Flex入门有门槛，我们GIS开发既然都会Flex了，而且我们开发的地理信息系统，整个系统都是Flex开发的，那肯定是直接用ArcGIS Flex API会更灵活，所以不用。

还有一个同事更厉害，他直接去研究Flex，入门后自己封装了一套地图接口，自己用。我研究过他封装的接口，他的接口和我们的接口都能解决业务问题，但定义接口时的出发点感觉明显不一样，我们是站在功能的角度封装，提供添加点，添加线，缓冲等功能。他是站在用户的角度，比如从数据库查出来一堆数据，把这堆数据直接丢给接口，就在地图上展示出来了。总结就是，他的接口封装度更高，更贴近他的实际使用习惯，而我们的接口更像是把ArcGIS的Flex接口翻译了一套JS的。

还注意到一个现象，经常有使用我们接口的业务开发人员跑过来问，为什么我的地图不显示？我过去看时，通常有两种原因，一种是地图服务的地址不对，当时的地图服务都是用ArcGIS server发布，ArcGIS server地图服务的rest地址是个网页，这个网页打开后，有很多级的链接，业务人员不知道应该拷贝哪一级的地址，经常考错，所以地图出不来。另一种是，后来添加的地图和第一次添加地图的坐标不一致，导致后续添加的地图都不显示。想想也是，地图资源和地图坐标这些对于不懂GIS的开发人员还是挺难的。

总结：

1. 这一版的接口封装的太基础了，不够贴近业务
2. 好的技术支持很重要，能弥补很多技术上的不足
3. 地图资源和地图坐标属于





1. 接口封装的太基础了

		1. 
  		2. 没有整合地图资源，经常会有人问，应该传arcgis的rest服务中的哪个地址。还有大家不懂地图的坐标，不知道哪些地图和哪些地图能一起显示
  		3. 		2. 用户反馈，c#初级开发人员觉得好用，能解决问题。c#中级人员觉得不好用，不如自己去直接用arcgis的JS api，但也还在用。c#的高级人员基本不用，有两个人的反应印象比较深：
       ​			1. 有个同事不用，理由是你们自己开发的东西自己都不用，言外之意是，你们自己都不用的东西不会好用
       ​			2. 还有个同事不用，原因他自己去研究flex，然后自己封装了一套接口，自己用自己的。我研究他封装的接口，他的接口和我们的接口都能解决业务问题，但定义接口时的出发点感觉明显不一样，我们是站在功能的角度我能提供加点，加线，缓冲的功能。他是站在用户的角度，我从数据库查出来一堆数据，把这些数据直接丢给接口，就在地图上展示出来了。总结就是，他的接口封装度更高，更贴近他的实际使用习惯，而我们的接口更像是把arcgis的flex接口翻译了一套JS的。从中学到，定义接口时要站在用户的角度。

## 第二版 2016年

### 背景

​		1. B公司，B1.0
​		2. 公司的业务是有海量定位数据，都是点数据，直接存放在了在大数据框架下的数据库中
​		3. 系统必须部署在内网中，无法访问互联网，底图数据需要离线互联网地图的瓦片
​		4. 面向的用户都是不懂GIS的

### 技术选型

​		1. h5时代来临，flex过时，开始拥抱开源

### 技术架构

​		1. 使用地图下载器，下载互联网地图，定义好瓦片的命名规则
​		2. 用tomcat发布下载的互联网地图瓦片
​		3. 前端用openlayers，根据前面的地图瓦片命名规则，写一个加载离线地图的功能。
​		4. 地图展示用openlayers，根据公司业务封装一套openlayers的接口，并提供接口的使用说明和调用示例
​		5. 简单的GIS数据分析直接在java后台完成，复杂的GIS数据分析、提取使用ArcGIS Engine完成。

### 经验总结

​		1. 关于地图下载器，虽然大家都要能力自己写一个出来，但真的挺不划算的，最好的解决方案就是花公司的钱去买一个许可，站在公司的角度没几块钱
​		2. AE的版本，C#版的比较稳定，Java版的超级难用，非常不稳定，动不动就死给你看，更不要尝试去把它部署到Linux服务器，不要问我是怎么知道的。我当时为了在linux上部署，先开发了一版java的，部署后一天崩溃好几次，动不动就内存溢出，根本没法用，没办法只能重新写了一版C#的部署在windows服务器上。

## 第三版 2017年

### 背景

​		1. C公司，C1.0
​		2. 换公司了，管网业务，需要空间数据库和GIS服务端了
​		3. 需要对管网gis数据进行编辑、存储、发布、应用
​		4. 用户中，有一半是懂GIS的，一半是不懂GIS的

### 用户研究

​		1. 一直有个疑问，为什么非GIS开发人员，能够用百度地图api，高德地图api，但却用不了arcgis api，openlayer，leaflet？结论有2个
​			1. 互联网地图api的帮助文档和示例是中文的
​			2. 互联网地图解决了地图资源问题，数据都是我发布的，你只管用就行，不用管去哪找数据，如何处理数据，如何发布数据
​		2. 那大家在用互联网地图时遇到了什么问题呢？
​			1. 坐标问题，不同地图间的坐标不同，有好几个坐标
​			2. 离线使用问题

### 技术选型

​		1. 前台转向更轻巧的leaflet，当时的考虑：
​			1. 小巧，简单，可塑性强
​			2. 可以同时兼容web端和移动端
​			3. 有esri维护的leaflet插件，能很好的兼容arcgis地图服务
​		2. 后台使用geoserver，当时的考虑：
​			1. 主流开源gis服务端
​			2. 支持连接postgis库、支持连接sde
​		3. 空间数据库使用postgis
​			1. 主流开源空间数据库好像就这一个

### 技术架构

​		1. 在leaflet的基础上封装了一层自己的接口，原生leaflet接口不对外，原因
​			1. 这样容易解决互联网地图偏移的问题，对外统一使用wgs84坐标，内部根据不同的底图将数据转换为对应的坐标
​			2. 可以实现类似jQuery的扁平化接口，简单易用
​			3. leaflet中点的写法是[纬度,经度]，而我们通常更习惯使用[经度,纬度]，封装后可以完全按我们的习惯来。
​		2. 帮助文档以接口为线索，接口内部有接口说明和调用事例
​		3. 开发geoserver扩展插件，geoserver不能满足的基础分析功能，和业务定制的后台分析功能，走geoserver的扩展开发
​		4. 基于geoserver的rest接口实现地图服务的自动发布。
​		5. 搭建一个门户网站，内容主要包括接口示例、接口文档、地图资源等

### 经验总结

​		1. geoserver的配图不好用，尝试了在QGIS上配图，然后发布到geoserver上，发现QGIS上配图后生产的sld样式文件格式，有很多geoserver都不支持，也不知道是版本没对应上还是咋地，最后找了个开源工具SLDEditor来编辑样式文件，完美解决问题。但整体的使用体验跟ArcGIS差很多。
​		2. gis的后台分析功能一开始通过geoserver扩展插件实现，后来直接用自己写的Java后台。总结。和geo server制图相关的功能。适合写插件来实现。和制图相不相关的功能，就没有必要用geo server扩展插件来实现，直接用Java后台来实现会更灵活方便，因为整个架构中门户网站也需要Java后台，所以就直接放一起了。
​		3. Post GIS 的空间分析功能很好用。很强大。所以空间分析功能，我们就主要用POS的GIS来实现了。（比如缓冲查询功能链接）

## 第四版 2019年

### 背景

​		1. C公司，C2.0
​		2. 开发出第三版后，在部门内部使用了大概一年多，发现了其中的一些问题
​		3. 这一版做出来后，我发现自己一个现象，当我需要写一个地图功能时，我的第一反应不是去用我自己封装的地图api，而是更愿意直接用leaflet去写，原因是我觉得封装的api用起来不够灵活，不如直接去用原生的leaflet。天哪，这不就和第一版时，同事说我们“你们自己封装的api自己都不用”，一样一样的吗
​		4. 使用人员中有懂GIS的，反馈最强烈的是能不能把原生接口放开。
​		5. 我们自己的感觉是天天对leaflet基础的功能进行封装，没有时间去研究更深层次的功能。

### 用户研究

​		1. 大家的使用习惯是先看示例，如果是自己要找的功能，就直接把代码拷走，然后和自己的数据对接一下就能用了
​		2. 如果是自己要找的功能，但示例代码的样式自己不满意，或想加个特定的鼠标事件等，这个时候就会去翻看接口说明
​		3. 基于以上两点，我们将帮助文档改为以示例为线索，示例中给出可执行代码，将代码中用到的类和接口给出类参考的直达链接
​		4. 再将leaflet的类参考文档进行翻译，放到平台中，
​		5. 之前一直追求接口要简洁，所以一直使用jquery式的扁平化接口，这种形式优点是容易上手，使用方便，缺点是对于一些复杂功能，比如绘图、轨迹回放等，就无法用一个接口完成。
​		6. 同样，又去研究百度、高德的地图api，得出结论是，
​			1. leaflet的原生接口已经非常简洁了，甚至比百度高德的地图api都简洁，单从简洁性考虑的话，没必要封装。
​			2. 使用者都是有js开发功底的，只要示例和说明文档写明白了，接口是否是扁平化的不重要。
​			3. 直接把原生接口放开，用户会不会习惯了之前的模式，觉得原生的不好理解，或不习惯，就比如纬度、经度的问题。结果是，用户更关心有没有能直接用的示例，里面具体的细节，用注释说清楚就行。

### 技术架构

​		1. 技术架构和上一版一样，不同的这一版放开了原生接口，不再对接口进行封装。
​		2. 不再对接口封装导致和上一版的接口不兼容，我们的解决办法时，上一个版本继续维护，但不再做功能升级，新项目就推荐使用这个版本。
​		3. 能把地图原生接口放开的另一个原因是，我们在互联网地图纠偏技术上取得了突破
​		4. 不再开发geoserver扩展插件，而是直接使用java后台，使用geoserver扩展写功能的好处是可以直接使用geoserver中的资源和功能，比如数据库配置等。

### 经验总结

​		1. leaflet类参考文档的翻译工作做的不好，没翻译几页，但发现对大家完全没有影响，两个原因，一是大家都是程序员，简单的英文文档基本能看懂，二是大家其实基本不咋看文档，更多的是看示例，示例没有的，会直接问我们，最后文档还是我们自己在看（捂脸）
​		2. 这一版我们维护的模式是，先把常用的示例都写上，后续有用户在示例中没有找到自己需要的，过来找我们，简单的功能我们就直接用原生api写个示例，也不用封装，直接把示例挂到帮助网站上。如果是复杂的功能再考虑封装。
​		3. 到这一版，整体的用户体验，已经和百度、高德地图api持平了。
​			1. 地图样式，不如百度高德地图丰富，因为百度高德地图支持自定义地图，我们只支持网上公开的那几种样式资源，但在绝大多数情况下是够用的
​			2. 接口易用性上持平
​			3. 在技术支持上我们是完胜的

## 第五版 2021年

### 背景

​		1. C公司，C3.0
​		2. 解决地图美观度问题
​		3. 解决前台展示性能问题
​		4. 解决geoserver不好配图的问题

### 用户体验。

​		1. 上一版的用户体验已经很不错了。发布后到现在已经两年了。没有再收到过不好用的反馈。
​		2. 在项目中作为技术中台，为其他公司提供支撑，反馈良好。
​		3. 但我们自己还是有追求的。和百度高德地图API相比，我们在性能和美观度还有所欠缺，要继续进步

### 目标

​		1. 在在用户体验上超过百度高德地图
​			1. 地图美观度上超过百度高德地图，实现自定义地图
​			2. 接口易用性上持平
​			3. 技术支持上超过
​			4. 地图资源准确性上不如，用机器学习解决，分使用场景

### 技术选型

​		1. 前台不再使用leaflet改为使用mapboxgl，原因有两个
​			1. 性能上提升，mapboxgl基于webgl技术开发，，leaflet的上限在10万左右（详见leaflet如何加载10万数据），而mapboxgl支持的最大数据量取决于显卡性能和网络传输速度，理想情况下可以轻松达到百万级别。
​			2. 美观度上提升，mapboxgl对矢量瓦片的支持特别好，可以实现前台动态渲染地图，可以实现类似百度高德地图的自定义地图功能。
​		2. 业务数据使用geoserver发布矢量瓦片
​		3. 底图数据有两种方案，
​			1. 对地图样式要求不高，或对底图的数据准确性要求很高，可以继续现有的互联网栅格地图资源。
​			2. 对地图样式要求很高，但对底图数据的准确性要求不高，可以使用本地发布的OSM矢量瓦片地图，具体实现类似百度高德地图的自定义地图，百度、高德地图的矢量瓦片不对外，必须要用他们的api才能使用 ，mapbox的矢量瓦片有调用次数限制，而使用openmaptiles本地发布OSM地图可以很好的解决这个问题（详见。。。） 
​		4. 底图数据的矢量瓦片用maptiles发布
​		5. 使用maputnik加载maptiles和geoserver发布的矢量瓦片地图，实现前台自定义配图。这里可以实现将业务数据底图的深度融合，比如把业务数据中的河流放到底图道路图层的下方，并实现标签的自动避让。正常情况下maputnik是不支持geoserver发布的矢量瓦片服务的，解决方法详见这里（）

## 总结

 	1. 解决地图资源问题
 	2. 解决坐标偏移问题，对外统一坐标
 	3. 对于不懂GIS的用户，是扁平化接口还是类方式的接口不重要，重要的是要用完善的示例和文档，
 	4. 对于懂GIS的用户，把原生接口放开很重要
 	5. 可直接使用的示例好于文档
 	6. 自己的api自己要乐意用
 	7. 用户支持要好，打败百度高德