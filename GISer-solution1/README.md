# 我的开源GIS解决方案之路（上）



## 缘起

今天跟大家分享一下我的开源GIS解决方案经历。从第一版到现在，前后跨度7年，经历了3个公司，共封装了5版地图API。

我一直在传统IT行业，公司都是以做面向政府的项目为主，俗称toG业务。

这种公司里，GIS在其中的应用通常为两种，一种是GIS结合公司的业务形成一个xx地理信息系统或是xx一张图系统，另一种是结合公司业务封装一套地图API，为公司的其它业务系统提供地图技术支撑，类似于高德地图API、百度地图API。

我们今天重点聊一下封装地图API这个事。

5版地图API中， 第一版使用的ArcGIS，后面的都是使用开源GIS。



## 第一版 2014年

### 背景

公司做环保业务，业务系统主要用C#开发，业务系统中涉及地图的部分使用ArcGIS Flex API开发，由GIS开发人员负责。那个年代，地图还主要是用Flex开发，因为Flex在那时很炫酷。

随着项目的增加，发现很多业务功能在项目里是通用的，再后来发现，如果把业务功能和地图功能分离，再把Flex编写的地图功能封装一套面向JS的接口，C#开发人员就可以自己完成地图相关的工作了。

于是我们准备封装一套用Felx编写的，面向C#开发人员的JS地图API。

### 技术架构

用ArcGIS Flex API开发地图功能，Flex支持和JS交互，利用这一特性将Flex开发的地图功能，封装成面向JS的接口。

开发一个简单的帮助网站，提供接口的调用示例和使用说明。

### 经验总结

地图API发布后，在做技术支持的过程中发现一个有趣的现象，关于地图API的使用，完全不懂GIS的初级C#开发人员觉得好用，原因是能帮他们解决问题，有困难时可以随时找我们技术支持。

了解一点GIS的中级C#开发人员觉得不好用，他们会拿我们的地图API和ArcGIS JS API对比，觉得后者更好用，但由于ArcGIS JS API的地图偏丑，我们也不提供技术支持，需要他们自己去研究，最终还是选择用我们的地图API。

了解一点GIS的高级C#开发人员基本不用，其中有两个同事的反应令我印象深刻，一个同事说：”你们自己开发的东西，自己都不用“。言外之意是，你们自己都不用的东西不会好用。但我们的想法是，把Flex封装一套JS的地图接口是因为Flex入门有门槛，我们GIS开发人员既然都会Flex了，而且我们开发的地理信息系统，整个都是用Flex开发的，那肯定是直接用ArcGIS Flex API会更灵活，所以不用。

还有一个同事更牛，他直接去研究Flex，不会的就问我们，入门后直接封装了一套地图接口自己用。我们研究过他封装的接口，虽然功能简单了些，但定义接口时的出发点明显感觉和我们不一样，我们是站在功能的角度封装，尽量保证接口的复用度高，比如添加点，添加线，缓冲等功能。他是站在用户的角度封装，比如从数据库查出来一堆数据，把这堆数据直接丢给接口，就在地图上展示出来了。总体而言，他的接口封装度更高，更贴近他的实际使用习惯，而我们的接口更像是把ArcGIS的Flex接口翻译了一套JS的。

还注意到一个现象，经常有使用我们接口的业务开发人员跑过来问，为什么我的地图不显示？经历的多了，发现通常有两种原因，一种是地图服务的地址不对，当时的地图服务都是用ArcGIS server发布，ArcGIS server地图服务的rest地址是个网页，这个网页打开后，有很多级的链接，业务人员不知道应该拷贝哪一级的地址，经常考错，所以地图出不来。另一种是，后来添加的地图和第一次添加地图的坐标不一致，导致后续添加的地图都不显示。想想也是，地图资源和地图坐标这些对于不懂GIS的开发人员还是挺难的。

虽然有这样那样的问题，但整体还是很大的提升了工作效率的。

总结：

1. 这一版的接口封装的太基础了，不够贴近业务？
2. 好的技术支持很重要，能弥补很多技术上的不足
3. 地图资源和地图坐标对于业务开发人员的门槛较高，需要进行包装



## 第二版 2016年

### 背景

换公司了，新公司做网安业务，有海量定位数据，GIS在其中的作用是，对定位数据进行提取、分析、展示，从而帮助客户解决业务问题。

公司有一个GIS应用系统，里面包含和GIS强相关的业务功能，另外其它部门有地图的功能需求时也会找到GIS部门来，这个场景和上家公司很像。

公司GIS部门的技术架构是，底图数据使用互联网地图瓦片，因为系统部署在客户内网中，无法访问互联网，所以需要下载互联网地图的瓦片，再拷贝到客户内网发布。发布的方式是，使用geoserver 的 GeoWebCache 功能读取瓦片并发布成WMS地图服务，前端使用openlayers进行地图展示。

第二版地图API使用openlayers，有了第一版地图API的经验，第二版地图API重点解决了地图的地图资源问题和地图坐标问题。

### 技术架构

1. 地图资源问题，对底图资源进行统一管理，提供多个底图类型供用户选择，包括高德地图、谷歌地图、天地图等。
2. 地图坐标问题，对外统一使用WGS84坐标，地图API内部负责将WGS84坐标转换为和底图匹配的坐标，包括gcj02坐标、bd09坐标等。
3. 简化互联网地图瓦片发布流程，在openlayers中写一个加载本地瓦片地图的功能，这样地图瓦片可以直接使用tomcat发布，不再需要使用geoserver的GeoWebCache发布。
4. GIS数据分析，GIS数据的分析、提取工作，使用ArcGIS Engine开发单独的工具完成。

### 经验总结

     		1. 解决地图资源和坐标问题，可以大大提升用户体验。
     		2. 关于地图下载器，虽然大家都有能力自己写一个出来，但真的挺不划算的，最好的解决方案就是花公司的钱去买一个许可，站在公司的角度这都没几块钱。
     		3. ArcGIS Engine的版本，C#版的比较稳定，Java版的超级难用，非常不稳定，动不动就死给你看，更不要尝试去把它部署到Linux服务器，不要问我是怎么知道的。我当时为了在linux上部署，先开发了一版java的，部署后一天崩溃好几次，动不动就内存溢出，根本没法用，没办法只能重新写了一版C#的部署在windows服务器上。



## 第三版 2017年 

### 背景

换公司了，新公司做管网业务，相比前面两家，业务和GIS的相关性更强一些，需要对管网GIS数据进行编辑、存储、发布和应用。公司之前地图都是使用ArcGIS开发的，正在谋求向开源GIS转型。于是就顺理成章的开始了我的第三版地图API开发。

在开始这一版之前，仔细研究了一下高德和百度地图API，并问了自己两个问题：

一、为什么非GIS开发人员，能够用高德、百度地图API解决问题，却用不了ArcGIS，openlayers，leaflet？

二、非GIS开发人员在用互联网地图API时遇到了哪些其它问题？

下面是我自己的理解，

第一个问题是因为，1、非GIS开发人员不用自己发布地图数据，互联网地图解决了地图资源问题，地图都是官方提供的，只管用就行。2、互联网地图API的帮助文档和示例都是中文的。入门难度和其它JS控件是一样，门槛低。

第二个问题，我在尝试使用这两个API以后发现，API的离线使用是个问题，互联网地图API都只能在线使用，无法离线使用，如果遇到不能访问互联网的情况，就无法使用了。

从这一版开始，我们开始尝试在用户体验上去对标高德、百度地图API。

### 技术选型

前台没有继续使用openlayers，而是转向更为轻巧的leaflet，当时的考虑是：

     		1. leaflet很小巧，核心代码结构简单容易理解，可塑性强，适合拿来改造为自己的API。
     		2. leaflet可以同时兼容web端和移动端
     		3. 有esri维护的leaflet插件，能很好的集成公司之前发布的ArcGIS地图服务

后台使用geoserver，geoserver有插件支持连接ArcGIS 的SDE空间数据库，可以很好的集成公司之前的ArcGIS空间数据库。

空间数据库使用postGIS。

桌面端开发继续使用ArcGIS Engine，没有去尝试QGIS，主要原因是，公司之前在ArcGIS Engine上有大量的技术积累，已经形成了成熟产品，转换成本会很高。

### 技术架构

在leaflet的基础上封装了一层自己的接口，原生leaflet接口不对外，当时的考虑是：

     		1. 和上一版一样，封装后容易解决互联网地图偏移的问题，对外统一使用WGS84坐标，内部根据不同的底图将数据转换为对应的坐标
     		2. 可以实现类似JQuery那样的扁平化接口，简单易用
     		3. leaflet中点的写法是[纬度,经度]，而我们通常更习惯使用[经度,纬度]的写法，通过封装可以解决这个问题。​

需要复杂的GIS分析和业务定制的GIS分析时，编写geoserver的扩展插件，插件连接PostGIS空间数据库，通过直接调用或自定义PostGIS空间分析函数来实现。

基于geoserver的rest接口实现地图服务的自动发布。在ArcGIS Engine开发的桌面软件中，先将GIS数据导入到空间数据库中，再调用geoserver的rest接口发布地图，最终实现效果和用ArcMap将地图发布到ArcGIS server中的体验相同。

搭建一个门户网站，内容包括帮助文档、地图资源、更新说明等，帮助文档以接口为线索，接口内部有接口说明和调用事例。地图资源中提供可以使用的所有地图，包括互联网地图和自己发布的业务地图，每个地图都有id，根据这个id就可以在地图API中轻松加载地图，不需要关心地图服务是如何发布的。

### 经验总结

1. 可以使用SLDEditor软件解决geoserver配图不好用的问题。geoserver的配图不好用，尝试了在QGIS上配图，然后发布到geoserver上，发现QGIS上配图后生成的sld样式文件格式，有很多geoserver都不支持，也不知道是版本没对应上还是咋地，最后找了个开源工具SLDEditor来编辑样式文件，完美解决问题，但整体的使用体验跟ArcGIS差很多。
2. PostGIS的空间分析功能很好用、很强大。所以空间分析功能，我们就主要用PostGIS来实现了，比如之前写过的缓冲查询功能。
3. geoserver扩展更适合开发和生成地图服务相关的功能。GIS的空间分析功能一开始通过geoserver扩展插件实现，后来发现扩展插件的后台程序主要作用是数据传输，最主要环节的GIS空间分析环节是在空间数据库PostGIS中实现的，而geoserver的扩展开发环境比较复杂，不如自己写的java后台好维护，于是就不再用geoserver的扩展了。geoserver扩展的优势是可以直接调用geoserver的资源和功能，它更适合开发和生成地图服务相关的功能。



好了，今天就先写到这里，过两天我再把下篇赶出来。



* * *

原文地址：[http://gisarmory.xyz/blog/index.html?blog=GISerMission](http://gisarmory.xyz/blog/index.html?blog=GISerMission)

关注《[GIS兵器库](http://gisarmory.xyz/blog/index.html?blog=wechat)》， 第一时间获得更多高质量GIS文章。

![](http://blogimage.gisarmory.xyz/20200923063756.png)

本文章采用 [知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议 ](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)进行许可。欢迎转载、使用、重新发布，但务必保留文章署名《GIS兵器库》（包含链接：  [http://gisarmory.xyz/blog/](http://gisarmory.xyz/blog/)），不得用于商业目的，基于本文修改后的作品务必以相同的许可发布。





