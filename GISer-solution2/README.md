# 我的开源GIS解决方案之路（二）



## 缘起

今天给大家分享一下我的开源GIS解决方案经历，（过渡）前后跨度7年，经历了3个公司，封装了5版地图API。

我一直在传统IT行业，公司都是以做面向政府的项目为主，俗称toG业务。

这种公司里，GIS在其中的应用通常为两种，一种是GIS结合公司的业务形成一个xx地理信息系统或是xx一张图系统，另一种是结合公司业务封装一套地图API，用来给公司的其它业务系统提供地图技术支撑，类似高德地图API、百度地图API。

我们今天重点聊一下封装地图API这个事。

我在3个公司一共封装了5版地图API， 第一版使用ArcGIS，后面的版本使用开源GIS。







## 第四版 2019年

### 背景

开发出第三版后，在部门中使用了一年多，一些问题开始慢慢暴露出来。

首先是我自己，当我需要研究或测试一个地图功能时，我的第一反应不是去用我自己封装的地图API，而是更愿意直接用原生leaflet去写，原因是我觉得自己封装的地图API用起来不够灵活。天呐，这不就和第一版时，同事说我们“你们自己封装的地图API自己都不用”是一样一样的嘛，如果说第一版时还有Flex语言的因素，那这第三版从内到外都是JS写的，没什么好解释的，就是让人家说中了。

使用人员中有一半是懂GIS的，他们之前都是使用ArcGIS JS API，用了leaflet封装的第三版地图API后，他们的第一反应是这个好轻便，比ArcGIS JS API 小了好多，加载很快。又用了一段时间以后，他们反馈最强烈的是能不能把原生接口放开，因为他们已经习惯了使用原生API，很多问题他们是有能力自己解决的，当他们想自由发挥一下时，发现自己被封装的这几个有限的接口给限制住了。

有个同事，每次来找我们时，都是事先在网上找好leaflet代码，然后让我们添加这个功能，整的我们都挺不好意思的。如果能把leaflet原生接口放开，有很多工作就不用等我们他们就能自己做了，

  		1. C公司，C2.0
       ​		2. 开发出第三版后，在部门内部使用了大概一年多，发现了其中的一些问题
       ​		3. 这一版做出来后，我发现自己一个现象，当我需要写一个地图功能时，我的第一反应不是去用我自己封装的地图api，而是更愿意直接用leaflet去写，原因是我觉得封装的api用起来不够灵活，不如直接去用原生的leaflet。天哪，这不就和第一版时，同事说我们“你们自己封装的api自己都不用”，一样一样的吗
       ​		4. 使用人员中有懂GIS的，反馈最强烈的是能不能把原生接口放开。
       ​		5. 我们自己的感觉是天天对leaflet基础的功能进行封装，没有时间去研究更深层次的功能。

### 用户研究

​		1. 大家的使用习惯是先看示例，如果是自己要找的功能，就直接把代码拷走，然后和自己的数据对接一下就能用了
​		2. 如果是自己要找的功能，但示例代码的样式自己不满意，或想加个特定的鼠标事件等，这个时候就会去翻看接口说明
​		3. 基于以上两点，我们将帮助文档改为以示例为线索，示例中给出可执行代码，将代码中用到的类和接口给出类参考的直达链接
​		4. 再将leaflet的类参考文档进行翻译，放到平台中，
​		5. 之前一直追求接口要简洁，所以一直使用jquery式的扁平化接口，这种形式优点是容易上手，使用方便，缺点是对于一些复杂功能，比如绘图、轨迹回放等，就无法用一个接口完成。
​		6. 同样，又去研究百度、高德的地图api，得出结论是，
​			1. leaflet的原生接口已经非常简洁了，甚至比百度高德的地图api都简洁，单从简洁性考虑的话，没必要封装。
​			2. 使用者都是有js开发功底的，只要示例和说明文档写明白了，接口是否是扁平化的不重要。
​			3. 直接把原生接口放开，用户会不会习惯了之前的模式，觉得原生的不好理解，或不习惯，就比如纬度、经度的问题。结果是，用户更关心有没有能直接用的示例，里面具体的细节，用注释说清楚就行。

### 技术架构

​		1. 技术架构和上一版一样，不同的这一版放开了原生接口，不再对接口进行封装。
​		2. 不再对接口封装导致和上一版的接口不兼容，我们的解决办法时，上一个版本继续维护，但不再做功能升级，新项目就推荐使用这个版本。
​		3. 能把地图原生接口放开的另一个原因是，我们在互联网地图纠偏技术上取得了突破
​		4. 不再开发geoserver扩展插件，而是直接使用java后台，使用geoserver扩展写功能的好处是可以直接使用geoserver中的资源和功能，比如数据库配置等。

### 经验总结

​		1. leaflet类参考文档的翻译工作做的不好，没翻译几页，但发现对大家完全没有影响，两个原因，一是大家都是程序员，简单的英文文档基本能看懂，二是大家其实基本不咋看文档，更多的是看示例，示例没有的，会直接问我们，最后文档还是我们自己在看（捂脸）
​		2. 这一版我们维护的模式是，先把常用的示例都写上，后续有用户在示例中没有找到自己需要的，过来找我们，简单的功能我们就直接用原生api写个示例，也不用封装，直接把示例挂到帮助网站上。如果是复杂的功能再考虑封装。
​		3. 到这一版，整体的用户体验，已经和百度、高德地图api持平了。
​			1. 地图样式，不如百度高德地图丰富，因为百度高德地图支持自定义地图，我们只支持网上公开的那几种样式资源，但在绝大多数情况下是够用的
​			2. 接口易用性上持平
​			3. 在技术支持上我们是完胜的

## 第五版 2021年

### 背景

​		1. C公司，C3.0
​		2. 解决地图美观度问题
​		3. 解决前台展示性能问题
​		4. 解决geoserver不好配图的问题

### 用户体验。

​		1. 上一版的用户体验已经很不错了。发布后到现在已经两年了。没有再收到过不好用的反馈。
​		2. 在项目中作为技术中台，为其他公司提供支撑，反馈良好。
​		3. 但我们自己还是有追求的。和百度高德地图API相比，我们在性能和美观度还有所欠缺，要继续进步

### 目标

​		1. 在在用户体验上超过百度高德地图
​			1. 地图美观度上超过百度高德地图，实现自定义地图
​			2. 接口易用性上持平
​			3. 技术支持上超过
​			4. 地图资源准确性上不如，用机器学习解决，分使用场景

### 技术选型

​		1. 前台不再使用leaflet改为使用mapboxgl，原因有两个
​			1. 性能上提升，mapboxgl基于webgl技术开发，，leaflet的上限在10万左右（详见leaflet如何加载10万数据），而mapboxgl支持的最大数据量取决于显卡性能和网络传输速度，理想情况下可以轻松达到百万级别。
​			2. 美观度上提升，mapboxgl对矢量瓦片的支持特别好，可以实现前台动态渲染地图，可以实现类似百度高德地图的自定义地图功能。
​		2. 业务数据使用geoserver发布矢量瓦片
​		3. 底图数据有两种方案，
​			1. 对地图样式要求不高，或对底图的数据准确性要求很高，可以继续现有的互联网栅格地图资源。
​			2. 对地图样式要求很高，但对底图数据的准确性要求不高，可以使用本地发布的OSM矢量瓦片地图，具体实现类似百度高德地图的自定义地图，百度、高德地图的矢量瓦片不对外，必须要用他们的api才能使用 ，mapbox的矢量瓦片有调用次数限制，而使用openmaptiles本地发布OSM地图可以很好的解决这个问题（详见。。。） 
​		4. 底图数据的矢量瓦片用maptiles发布
​		5. 使用maputnik加载maptiles和geoserver发布的矢量瓦片地图，实现前台自定义配图。这里可以实现将业务数据底图的深度融合，比如把业务数据中的河流放到底图道路图层的下方，并实现标签的自动避让。正常情况下maputnik是不支持geoserver发布的矢量瓦片服务的，解决方法详见这里（）

## 总结

 	1. 解决地图资源问题
 	2. 解决坐标偏移问题，对外统一坐标
 	3. 对于不懂GIS的用户，是扁平化接口还是类方式的接口不重要，重要的是要用完善的示例和文档，
 	4. 对于懂GIS的用户，把原生接口放开很重要
 	5. 可直接使用的示例好于文档
 	6. 自己的api自己要乐意用
 	7. 用户支持要好，打败百度高德