# openmaptiles生成自定义区域地图

[TOC]

## 1、缘起

1. `openmaptiles`提供了一套OSM数据使用的完整解决方案，在前面文章[如何实现OSM地图本地发布并自定义配图](http://gisarmory.xyz/blog/index.html?blog=OSMVectorTiles)中，我们详细介绍了如何安装`openmaptiles`，并生成了一个阿尔巴尼亚地区的“helloworld”。

2. 参照上篇文章的内容，输入下面的命令，就可以生成中国地图。

   ```
   ./quickstart.sh china 
   ```

3. 上面命令，需要耐心等待，我电脑4核8G，用了16个小时左右。最终会得到中国范围内，0-7级的矢量瓦片数据。

4. `openmaptiles`主要是从[geofabrik](https://download.geofabrik.de/)网站下载原始数据，geofabrik在中国地区下载的最小颗粒度是中国大陆和台湾，没有办法按大陆地区的省，或按自定义区域下载。



## 2、问题

1. 能不能按自定义区域生成地图？
2. 有哪些方法能提高处理速度？



## 3、分析

1. `openmaptiles`生成地图分4个步骤，数据下载、数据库入库、数据分析、生成矢量瓦片。
2. 问题一分析：
   1. 数据下载、数据库入库、数据分析这前三个步骤，只能按整个中国的数据来处理，最后的生成矢量瓦片可用通过控制生成范围、生成层级来实现只生成省、市、自定义区域的地图。
3. 问题二分析：
   1. 数据下载的时间取决于网速。
   2. 数据入库和数据分析的时间取决于机器性能。
   3. 生成矢量瓦片的时间取决于机器性能、生成范围、生成层级。
   4. 想要提高处理速度，针对上面的要素，对症下药。



## 4、生成自定义地区矢量瓦片

1. 跑了一遍`./quickstart.sh china `命令以后，后续就不需要再执行这个命令，只需要执行其中的第四步`生成矢量瓦片`的命令，就能生成自定义地区的矢量瓦片了。
2. `openmaptiles`生成的矢量瓦片，最大到14级，设置再大也没有用，因为前三步没有对更大级别的数据进行分析。
3. 第四步`生成矢量瓦片`的命令，会把上一次的结果清除，如果想把两次的结果放在一个里面，比如想把中国0-7级和北京8-14级的矢量瓦片放在一个.mbtiles文件中，则需要修改配置，让程序不清除上一次的结果。
4. 下面以生成全国范围0-7级地图+北京范围8-14级地图为例，说明如何来修改配置。
5. 为避免重启电脑后就各种不灵的尴尬，我们从重启电脑后开始。

### 4.1、启动docker

1. 检查docker是否启动

   ```
   docker --version
   ```

2. 如果没有启动，输入下面命令启动docker。如果有需要，后续可以自己把docker设置为开机自启动。

   ```
   systemctl start docker
   ```

### 4.2、启动postGIS容器

1. 进入`openmaptiles`文件夹

2. 启动postGIS容器

   ```
   make start-db-preloaded
   ```

### 4.3、设置不清理上次的结果

1. 打开`Makefile`文件，找到generate-tiles命令，在下图红框的位置，就是清除上次结果文件的命令。我们在这行前面输入`#`号，把它注释掉。
   ![](http://blogimage.gisarmory.xyz/20201221130844.png)

### 4.4、删除默认切图范围

1. 程序默认会用china.bbox中的范围参数作为切图范围，所以我们需要把这个文件删掉，这样才能用我们配置的范围。文件在`data`文件夹中。删除命令：

   ```
   rm -f ./data/china.bbox
   ```

### 4.5、修改切图层级和范围

1. 先切中国范围的0-7级，打开.env文件
2. 修改切图的层级`MIN_ZOOM`和`MAX_ZOOM`
   ![](http://blogimage.gisarmory.xyz/20201221130854.png)
3. 修改切图的范围`BBOX`，格式为：minX,minY,maxX,maxY
   ![](http://blogimage.gisarmory.xyz/20201221130905.png)

### 4.6、生成瓦片

1. 输入下面命令，生成瓦片

   ```
   make generate-tiles
   ```

2. 生成的结果是`tiles.mbtiles`文件，在`data`文件夹中

### 4.7、重复操作

1. 重复上两个步骤：修改切图层级和范围、生成瓦片。把参数改为北京的，就能最终得到在一个文件中的全国范围0-7级地图+北京范围8-14级地图。



## 5、总结

1. `openmaptiles`生成地图分4个步骤，数据下载、数据库入库、数据分析、生成矢量瓦片
2. 中国地区生成地图的最小颗粒度是中国大陆和台湾，没有办法按大陆地区的省，或按自定义区域进行生成。
3. 数据下载、数据库入库、数据分析这三个步骤，只能按整个中国的数据来处理，最后一步生成矢量瓦片可以通过控制生成范围、生成层级来实现生成自定义区域地图。
4. 前三个步骤只需要执行一次，最后一个步骤可以多次执行。
5. 如果想把多次生成的矢量瓦片放在一个文件中，可以设置不清除上次生成的结果。



